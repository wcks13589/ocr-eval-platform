<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è©³ç´°åˆ†æ•¸ - {{ detail_data.name }}</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="container" style="max-width: 1200px;">
        <div class="detail-header">
            <h1>ğŸ“Š è©³ç´°è©•ä¼°çµæœ</h1>
            <div class="detail-summary">
                <div class="summary-card">
                    <span class="summary-label">ğŸ‘¤ åƒè³½è€…</span>
                    <span class="summary-value">{{ detail_data.name }}</span>
                </div>
                <div class="summary-card">
                    <span class="summary-label">ğŸ“ˆ å¹³å‡ TEDS</span>
                    <span class="summary-value highlight-score">{{ "%.4f"|format(detail_data.teds) }}</span>
                </div>
                <div class="summary-card">
                    <span class="summary-label">âœ… æœ‰æ•ˆè³‡æ–™</span>
                    <span class="summary-value">{{ detail_data.valid_count }} / {{ detail_data.total_count }}</span>
                </div>
            </div>
        </div>

        <div class="detail-actions">
            <a href="/" class="action-btn btn-back">â¬…ï¸ è¿”å›é¦–é </a>
            <button onclick="downloadCSV()" class="action-btn btn-download">ğŸ“¥ ä¸‹è¼‰ CSV</button>
            <button onclick="toggleFilter()" class="action-btn btn-filter" id="filterBtn">ğŸ” é¡¯ç¤ºç¯©é¸</button>
        </div>

        <!-- ç¯©é¸é¸é … -->
        <div id="filterOptions" style="display: none;" class="filter-panel">
            <div class="filter-group">
                <label>
                    <input type="checkbox" id="filterValid" checked onchange="applyFilter()"> 
                    é¡¯ç¤ºæ­£å¸¸è³‡æ–™
                </label>
                <label>
                    <input type="checkbox" id="filterMissing" checked onchange="applyFilter()"> 
                    é¡¯ç¤ºç¼ºå¤±è³‡æ–™
                </label>
                <label>
                    <input type="checkbox" id="filterError" checked onchange="applyFilter()"> 
                    é¡¯ç¤ºéŒ¯èª¤è³‡æ–™
                </label>
            </div>
            <div class="filter-group">
                <label>æœ€ä½åˆ†æ•¸ï¼š</label>
                <input type="number" id="minScore" min="0" max="1" step="0.01" value="0" onchange="applyFilter()">
                <label>æœ€é«˜åˆ†æ•¸ï¼š</label>
                <input type="number" id="maxScore" min="0" max="1" step="0.01" value="1" onchange="applyFilter()">
            </div>
        </div>

        <!-- çµ±è¨ˆè³‡è¨Š -->
        <div class="stats-panel">
            <h3>ğŸ“ˆ åˆ†æ•¸çµ±è¨ˆ</h3>
            <div class="stats-grid">
                <div class="stat-item">
                    <span class="stat-label">å®Œç¾åˆ†æ•¸ (1.0)</span>
                    <span class="stat-value" id="statPerfect">-</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">é«˜åˆ† (â‰¥0.8)</span>
                    <span class="stat-value" id="statHigh">-</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">ä¸­åˆ† (0.5-0.8)</span>
                    <span class="stat-value" id="statMedium">-</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">ä½åˆ† (<0.5)</span>
                    <span class="stat-value" id="statLow">-</span>
                </div>
            </div>
        </div>

        <!-- è©³ç´°åˆ†æ•¸è¡¨æ ¼ -->
        <div class="detail-table-wrapper">
            <table id="detailTable">
                <thead>
                    <tr>
                        <th style="width: 10%;">åºè™Ÿ</th>
                        <th style="width: 30%;">è¡¨æ ¼ ID</th>
                        <th style="width: 20%;">TEDS åˆ†æ•¸</th>
                        <th style="width: 20%;">ç‹€æ…‹</th>
                        <th style="width: 20%;">è©•ç´š</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in detail_data.details %}
                    <tr class="detail-row" 
                        data-status="{{ item.status }}" 
                        data-score="{{ item.score }}">
                        <td>{{ loop.index }}</td>
                        <td class="data-id">{{ item.id }}</td>
                        <td>
                            <span class="score-badge score-{{ 'perfect' if item.score == 1.0 else ('high' if item.score >= 0.8 else ('medium' if item.score >= 0.5 else 'low')) }}">
                                {{ "%.4f"|format(item.score) }}
                            </span>
                        </td>
                        <td>
                            {% if item.status == 'valid' %}
                                <span class="status-badge status-valid">âœ… æ­£å¸¸</span>
                            {% elif item.status == 'missing' %}
                                <span class="status-badge status-missing">âŒ ç¼ºå¤±</span>
                            {% else %}
                                <span class="status-badge status-error">âš ï¸ éŒ¯èª¤</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if item.score == 1.0 %}
                                <span class="grade-badge grade-perfect">ğŸŒŸ å®Œç¾</span>
                            {% elif item.score >= 0.8 %}
                                <span class="grade-badge grade-high">ğŸ˜Š å„ªç§€</span>
                            {% elif item.score >= 0.5 %}
                                <span class="grade-badge grade-medium">ğŸ˜ æ™®é€š</span>
                            {% else %}
                                <span class="grade-badge grade-low">ğŸ˜ å¾…æ”¹é€²</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <script>
        const detailData = {{ detail_data | tojson }};

        // è¨ˆç®—çµ±è¨ˆè³‡è¨Š
        function calculateStats() {
            const validDetails = detailData.details.filter(item => item.status === 'valid');
            const perfect = validDetails.filter(item => item.score === 1.0).length;
            const high = validDetails.filter(item => item.score >= 0.8 && item.score < 1.0).length;
            const medium = validDetails.filter(item => item.score >= 0.5 && item.score < 0.8).length;
            const low = validDetails.filter(item => item.score < 0.5).length;

            document.getElementById('statPerfect').textContent = perfect;
            document.getElementById('statHigh').textContent = high;
            document.getElementById('statMedium').textContent = medium;
            document.getElementById('statLow').textContent = low;
        }

        // ç¯©é¸åŠŸèƒ½
        function toggleFilter() {
            const filterOptions = document.getElementById('filterOptions');
            const filterBtn = document.getElementById('filterBtn');
            if (filterOptions.style.display === 'none') {
                filterOptions.style.display = 'block';
                filterBtn.textContent = 'ğŸ” éš±è—ç¯©é¸';
            } else {
                filterOptions.style.display = 'none';
                filterBtn.textContent = 'ğŸ” é¡¯ç¤ºç¯©é¸';
            }
        }

        function applyFilter() {
            const showValid = document.getElementById('filterValid').checked;
            const showMissing = document.getElementById('filterMissing').checked;
            const showError = document.getElementById('filterError').checked;
            const minScore = parseFloat(document.getElementById('minScore').value);
            const maxScore = parseFloat(document.getElementById('maxScore').value);

            const rows = document.querySelectorAll('.detail-row');
            rows.forEach(row => {
                const status = row.dataset.status;
                const score = parseFloat(row.dataset.score);

                let show = true;

                // ç‹€æ…‹ç¯©é¸
                if (status === 'valid' && !showValid) show = false;
                if (status === 'missing' && !showMissing) show = false;
                if (status.startsWith('error') && !showError) show = false;

                // åˆ†æ•¸ç¯„åœç¯©é¸
                if (score < minScore || score > maxScore) show = false;

                row.style.display = show ? '' : 'none';
            });
        }

        // ä¸‹è¼‰ CSV
        function downloadCSV() {
            let csv = 'åºè™Ÿ,è³‡æ–™ID,TEDSåˆ†æ•¸,ç‹€æ…‹\n';
            detailData.details.forEach((item, index) => {
                csv += `${index + 1},"${item.id}",${item.score},"${item.status}"\n`;
            });

            const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `${detailData.name}_è©³ç´°åˆ†æ•¸.csv`;
            link.click();
        }

        // é é¢è¼‰å…¥æ™‚è¨ˆç®—çµ±è¨ˆ
        document.addEventListener('DOMContentLoaded', function() {
            calculateStats();
        });
    </script>
</body>
</html>

