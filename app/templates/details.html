<!DOCTYPE html>
<html lang="{{ lang }}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ t.detail_title }} - {{ detail_data.name }}</title>
    <link rel="stylesheet" href="/static/style.css">
    <style>
        .lang-switcher {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 20px;
        }
        .lang-btn {
            padding: 6px 12px;
            background: #f7fafc;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s;
            text-decoration: none;
            color: #4a5568;
        }
        .lang-btn:hover {
            background: #edf2f7;
            border-color: #cbd5e0;
        }
        .lang-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
        }
    </style>
</head>
<body>
    <div class="container" style="max-width: 1200px;">
        <div class="lang-switcher">
            <a href="/set_language/zh-TW" class="lang-btn {% if lang == 'zh-TW' %}active{% endif %}">中文</a>
            <a href="/set_language/en" class="lang-btn {% if lang == 'en' %}active{% endif %}">English</a>
        </div>

        <div class="detail-header">
            <h1>{{ t.detail_title }}</h1>
            <div class="detail-summary">
                <div class="summary-card">
                    <span class="summary-label">{{ t.participant }}</span>
                    <span class="summary-value">{{ detail_data.name }}</span>
                </div>
                <div class="summary-card">
                    <span class="summary-label">{{ t.average_teds }}</span>
                    <span class="summary-value highlight-score">{{ "%.4f"|format(detail_data.teds) }}</span>
                </div>
                <div class="summary-card">
                    <span class="summary-label">{{ t.valid_data }}</span>
                    <span class="summary-value">{{ detail_data.valid_count }} / {{ detail_data.total_count }}</span>
                </div>
            </div>
        </div>

        <div class="detail-actions">
            <a href="/" class="action-btn btn-back">{{ t.back }}</a>
            <button onclick="downloadCSV()" class="action-btn btn-download">{{ t.download_csv }}</button>
            <button onclick="toggleFilter()" class="action-btn btn-filter" id="filterBtn">{{ t.show_filter }}</button>
        </div>

        <!-- 篩選選項 -->
        <div id="filterOptions" style="display: none;" class="filter-panel">
            <div class="filter-group">
                <label>
                    <input type="checkbox" id="filterValid" checked onchange="applyFilter()"> 
                    {{ t.show_normal }}
                </label>
                <label>
                    <input type="checkbox" id="filterMissing" checked onchange="applyFilter()"> 
                    {{ t.show_missing }}
                </label>
                <label>
                    <input type="checkbox" id="filterError" checked onchange="applyFilter()"> 
                    {{ t.show_error }}
                </label>
            </div>
            <div class="filter-group">
                <label>{{ t.min_score }}</label>
                <input type="number" id="minScore" min="0" max="1" step="0.01" value="0" onchange="applyFilter()">
                <label>{{ t.max_score }}</label>
                <input type="number" id="maxScore" min="0" max="1" step="0.01" value="1" onchange="applyFilter()">
            </div>
        </div>

        <!-- 統計資訊 -->
        <div class="stats-panel">
            <h3>{{ t.score_statistics }}</h3>
            <div class="stats-grid">
                <div class="stat-item">
                    <span class="stat-label">{{ t.perfect_score }}</span>
                    <span class="stat-value" id="statPerfect">-</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">{{ t.high_score }}</span>
                    <span class="stat-value" id="statHigh">-</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">{{ t.medium_score }}</span>
                    <span class="stat-value" id="statMedium">-</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">{{ t.low_score }}</span>
                    <span class="stat-value" id="statLow">-</span>
                </div>
            </div>
        </div>

        <!-- 詳細分數表格 -->
        <div class="detail-table-wrapper">
            <table id="detailTable">
                <thead>
                    <tr>
                        <th style="width: 10%;">{{ t.serial_number }}</th>
                        <th style="width: 30%;">{{ t.table_id }}</th>
                        <th style="width: 20%;">{{ t.teds_score_col }}</th>
                        <th style="width: 20%;">{{ t.status }}</th>
                        <th style="width: 20%;">{{ t.rating }}</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in detail_data.details %}
                    <tr class="detail-row" 
                        data-status="{{ item.status }}" 
                        data-score="{{ item.score }}">
                        <td>{{ loop.index }}</td>
                        <td class="data-id">{{ item.id }}</td>
                        <td>
                            <span class="score-badge score-{{ 'perfect' if item.score == 1.0 else ('high' if item.score >= 0.8 else ('medium' if item.score >= 0.5 else 'low')) }}">
                                {{ "%.4f"|format(item.score) }}
                            </span>
                        </td>
                        <td>
                            {% if item.status == 'valid' %}
                                <span class="status-badge status-valid">{{ t.status_normal }}</span>
                            {% elif item.status == 'missing' %}
                                <span class="status-badge status-missing">{{ t.status_missing }}</span>
                            {% else %}
                                <span class="status-badge status-error">{{ t.status_error }}</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if item.score == 1.0 %}
                                <span class="grade-badge grade-perfect">{{ t.grade_perfect }}</span>
                            {% elif item.score >= 0.8 %}
                                <span class="grade-badge grade-high">{{ t.grade_excellent }}</span>
                            {% elif item.score >= 0.5 %}
                                <span class="grade-badge grade-medium">{{ t.grade_average }}</span>
                            {% else %}
                                <span class="grade-badge grade-low">{{ t.grade_improve }}</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <script>
        const detailData = {{ detail_data | tojson }};
        const lang = {{ lang | tojson }};
        const translations = {
            showFilter: {{ t.show_filter | tojson }},
            hideFilter: {{ t.hide_filter | tojson }},
            csvFilename: {{ t.csv_filename | tojson }},
            csvHeader: {{ t.csv_header | tojson }}
        };

        // 計算統計資訊
        function calculateStats() {
            const validDetails = detailData.details.filter(item => item.status === 'valid');
            const perfect = validDetails.filter(item => item.score === 1.0).length;
            const high = validDetails.filter(item => item.score >= 0.8 && item.score < 1.0).length;
            const medium = validDetails.filter(item => item.score >= 0.5 && item.score < 0.8).length;
            const low = validDetails.filter(item => item.score < 0.5).length;

            document.getElementById('statPerfect').textContent = perfect;
            document.getElementById('statHigh').textContent = high;
            document.getElementById('statMedium').textContent = medium;
            document.getElementById('statLow').textContent = low;
        }

        // 篩選功能
        function toggleFilter() {
            const filterOptions = document.getElementById('filterOptions');
            const filterBtn = document.getElementById('filterBtn');
            if (filterOptions.style.display === 'none') {
                filterOptions.style.display = 'block';
                filterBtn.textContent = translations.hideFilter;
            } else {
                filterOptions.style.display = 'none';
                filterBtn.textContent = translations.showFilter;
            }
        }

        function applyFilter() {
            const showValid = document.getElementById('filterValid').checked;
            const showMissing = document.getElementById('filterMissing').checked;
            const showError = document.getElementById('filterError').checked;
            const minScore = parseFloat(document.getElementById('minScore').value);
            const maxScore = parseFloat(document.getElementById('maxScore').value);

            const rows = document.querySelectorAll('.detail-row');
            rows.forEach(row => {
                const status = row.dataset.status;
                const score = parseFloat(row.dataset.score);

                let show = true;

                // 狀態篩選
                if (status === 'valid' && !showValid) show = false;
                if (status === 'missing' && !showMissing) show = false;
                if (status.startsWith('error') && !showError) show = false;

                // 分數範圍篩選
                if (score < minScore || score > maxScore) show = false;

                row.style.display = show ? '' : 'none';
            });
        }

        // 下載 CSV
        function downloadCSV() {
            let csv = translations.csvHeader;
            detailData.details.forEach((item, index) => {
                csv += `${index + 1},"${item.id}",${item.score},"${item.status}"\n`;
            });

            const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = translations.csvFilename.replace('{name}', detailData.name);
            link.click();
        }

        // 頁面載入時計算統計
        document.addEventListener('DOMContentLoaded', function() {
            calculateStats();
        });
    </script>
</body>
</html>
