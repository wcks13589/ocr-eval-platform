<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OCR è©•ä¼°å¹³å°</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="container">
        <h1>ğŸ§  OCR è©•ä¼°å¹³å°</h1>

        {% if error %}
            <div class="error">{{ error }}</div>
        {% endif %}

        {% if success_message %}
            <div class="success">{{ success_message }}</div>
        {% endif %}

        <form id="uploadForm" action="/evaluate" method="post" enctype="multipart/form-data">
            <div class="form-group">
                <label>ğŸ‘¤ åƒè³½è€…åç¨±</label>
                <input type="text" id="nameInput" name="name" required placeholder="è«‹è¼¸å…¥ä½ çš„åç¨±">
            </div>
            
            <div class="form-group">
                <label>ğŸ“„ ä¸Šå‚³çµæœæª”æ¡ˆ</label>
                <input type="file" id="fileInput" name="file" accept=".json" required>
            </div>
            
            <button type="submit" id="submitBtn">ğŸš€ é–‹å§‹è©•ä¼°</button>
        </form>

        <!-- é€²åº¦æ¢å€åŸŸ -->
        <div id="progressContainer" style="display: none;">
            <div class="progress-wrapper">
                <h3 id="progressTitle">â³ æ­£åœ¨è™•ç†æ‚¨çš„æª”æ¡ˆ...</h3>
                <div class="progress-bar-container">
                    <div class="progress-bar" id="progressBar">
                        <span class="progress-text" id="progressText">0%</span>
                    </div>
                </div>
                <div class="progress-info">
                    <span id="progressDetail">æº–å‚™é–‹å§‹...</span>
                </div>
            </div>
        </div>

        <div id="leaderboard-section" style="margin-top: 50px; border-top: 2px solid #e2e8f0; padding-top: 40px;">
            <h2 style="color: #667eea; font-size: 2em; margin-bottom: 25px;">ğŸ† å³æ™‚æ’è¡Œæ¦œ</h2>

            {% if leaders %}
            <table>
                <thead>
                    <tr>
                        <th>ğŸ… åæ¬¡</th>
                        <th>ğŸ‘¤ åç¨±</th>
                        <th>ğŸ“Š TEDS</th>
                    </tr>
                </thead>
                <tbody>
                    {% for user in leaders %}
                    <tr {% if highlight_name and user.name == highlight_name %}class="highlight-row"{% endif %}>
                        <td>
                            {% if loop.index == 1 %}
                                <span class="badge badge-gold">ğŸ¥‡ 1</span>
                            {% elif loop.index == 2 %}
                                <span class="badge badge-silver">ğŸ¥ˆ 2</span>
                            {% elif loop.index == 3 %}
                                <span class="badge badge-bronze">ğŸ¥‰ 3</span>
                            {% else %}
                                {{ loop.index }}
                            {% endif %}
                        </td>
                        <td><strong>{{ user.name }}</strong></td>
                        <td><span class="metric-value">{{ "%.4f"|format(user.teds) }}</span></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
                <p class="info-text">ç›®å‰é‚„æ²’æœ‰ä»»ä½•ç´€éŒ„ï¼Œæˆç‚ºç¬¬ä¸€ä½æŒ‘æˆ°è€…å§ï¼ğŸš€</p>
            {% endif %}
        </div>
    </div>

    <script>
        // WebSocket é€²åº¦æ¢é‚è¼¯
        document.getElementById('uploadForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const nameInput = document.getElementById('nameInput');
            const fileInput = document.getElementById('fileInput');
            const submitBtn = document.getElementById('submitBtn');
            const progressContainer = document.getElementById('progressContainer');
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');
            const progressDetail = document.getElementById('progressDetail');
            const progressTitle = document.getElementById('progressTitle');
            
            const name = nameInput.value.trim();
            const file = fileInput.files[0];
            
            if (!name || !file) {
                alert('è«‹å¡«å¯«æ‰€æœ‰æ¬„ä½');
                return;
            }
            
            // æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨
            const existingNames = [{% for user in leaders %}'{{ user.name }}',{% endfor %}];
            if (existingNames.includes(name)) {
                alert(`åç¨±ã€Œ${name}ã€å·²å­˜åœ¨æ’è¡Œæ¦œï¼Œè«‹æ›ä¸€å€‹åç¨±ã€‚`);
                return;
            }
            
            // ä¸Šå‚³æª”æ¡ˆåˆ°ä¼ºæœå™¨
            const formData = new FormData();
            formData.append('file', file);
            formData.append('name', name);
            
            try {
                // å…ˆä¸Šå‚³æª”æ¡ˆ
                submitBtn.disabled = true;
                submitBtn.textContent = 'ğŸ“¤ ä¸Šå‚³ä¸­...';
                
                const uploadResponse = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                });
                
                const uploadResult = await uploadResponse.json();
                
                if (!uploadResult.success) {
                    throw new Error(uploadResult.error || 'æª”æ¡ˆä¸Šå‚³å¤±æ•—');
                }
                
                // é¡¯ç¤ºé€²åº¦æ¢
                progressContainer.style.display = 'block';
                submitBtn.textContent = 'â³ è©•ä¼°ä¸­...';
                
                // å»ºç«‹ WebSocket é€£æ¥
                const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                const sessionId = Date.now();
                const ws = new WebSocket(`${protocol}//${window.location.host}/ws/${sessionId}`);
                
                ws.onopen = function() {
                    // ç™¼é€è©•ä¼°è«‹æ±‚
                    ws.send(JSON.stringify({
                        name: name,
                        file_path: `data/uploads/${name}.json`
                    }));
                };
                
                ws.onmessage = function(event) {
                    const data = JSON.parse(event.data);
                    
                    if (data.type === 'progress') {
                        // æ›´æ–°é€²åº¦æ¢
                        progressBar.style.width = data.percentage + '%';
                        progressText.textContent = data.percentage + '%';
                        progressDetail.textContent = `æ­£åœ¨è©•ä¼°ç¬¬ ${data.current} / ${data.total} ç­†è³‡æ–™ (ID: ${data.current_key})`;
                    } else if (data.type === 'complete') {
                        // è©•ä¼°å®Œæˆ
                        progressBar.style.width = '100%';
                        progressText.textContent = '100%';
                        progressTitle.textContent = 'âœ… è©•ä¼°å®Œæˆï¼';
                        progressDetail.textContent = `${name} çš„ TEDS åˆ†æ•¸ç‚º ${data.result.TEDS}`;
                        
                        // 1.5ç§’å¾Œé‡æ–°è¼‰å…¥é é¢ä»¥é¡¯ç¤ºæ›´æ–°å¾Œçš„æ’è¡Œæ¦œ
                        setTimeout(function() {
                            window.location.href = `/?success=${encodeURIComponent(name)}&score=${data.result.TEDS}`;
                        }, 1500);
                    } else if (data.type === 'error') {
                        // éŒ¯èª¤è™•ç†
                        progressContainer.style.display = 'none';
                        alert(data.message);
                        submitBtn.disabled = false;
                        submitBtn.textContent = 'ğŸš€ é–‹å§‹è©•ä¼°';
                    }
                };
                
                ws.onerror = function(error) {
                    console.error('WebSocket éŒ¯èª¤:', error);
                    progressContainer.style.display = 'none';
                    alert('é€£æ¥éŒ¯èª¤ï¼Œè«‹é‡è©¦');
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'ğŸš€ é–‹å§‹è©•ä¼°';
                };
                
                ws.onclose = function() {
                    console.log('WebSocket é€£æ¥å·²é—œé–‰');
                };
                
            } catch (error) {
                console.error('éŒ¯èª¤:', error);
                alert('ç™¼ç”ŸéŒ¯èª¤ï¼š' + error.message);
                submitBtn.disabled = false;
                submitBtn.textContent = 'ğŸš€ é–‹å§‹è©•ä¼°';
                progressContainer.style.display = 'none';
            }
        });

        // è™•ç†æˆåŠŸåƒæ•¸
        const urlParams = new URLSearchParams(window.location.search);
        const successName = urlParams.get('success');
        const successScore = urlParams.get('score');
        
        if (successName && successScore) {
            // é¡¯ç¤ºæˆåŠŸè¨Šæ¯
            const container = document.querySelector('.container');
            const successDiv = document.createElement('div');
            successDiv.className = 'success';
            successDiv.textContent = `âœ… è©•ä¼°å®Œæˆï¼${successName} çš„ TEDS åˆ†æ•¸ç‚º ${successScore}`;
            container.insertBefore(successDiv, container.firstChild.nextSibling);
            
            // æ»¾å‹•åˆ°æ’è¡Œæ¦œ
            setTimeout(function() {
                const leaderboard = document.getElementById('leaderboard-section');
                if (leaderboard) {
                    leaderboard.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            }, 300);
        }

        {% if highlight_name %}
        // ç•¶æœ‰æ–°ä¸Šå‚³çš„è¨˜éŒ„æ™‚ï¼Œå¹³æ»‘æ»¾å‹•åˆ°æ’è¡Œæ¦œå€åŸŸ
        document.addEventListener('DOMContentLoaded', function() {
            const leaderboard = document.getElementById('leaderboard-section');
            if (leaderboard) {
                setTimeout(function() {
                    leaderboard.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }, 300);
            }
        });
        {% endif %}
    </script>
</body>
</html>
