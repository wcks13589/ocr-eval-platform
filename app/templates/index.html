<!DOCTYPE html>
<html lang="{{ lang }}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ t.app_title }}</title>
    <link rel="stylesheet" href="/static/style.css">
    <style>
        .lang-switcher {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .lang-btn {
            padding: 6px 12px;
            background: #f7fafc;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s;
            text-decoration: none;
            color: #4a5568;
        }
        .lang-btn:hover {
            background: #edf2f7;
            border-color: #cbd5e0;
        }
        .lang-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
        }
        .header-actions {
            display: flex;
            gap: 15px;
            align-items: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h1>{{ t.index_title }}</h1>
            <div class="header-actions">
                <div class="lang-switcher">
                    <a href="/set_language/zh-TW" class="lang-btn {% if lang == 'zh-TW' %}active{% endif %}">ä¸­æ–‡</a>
                    <a href="/set_language/en" class="lang-btn {% if lang == 'en' %}active{% endif %}">English</a>
                </div>
                <a href="/admin/login" style="color: #667eea; text-decoration: none; font-size: 0.9em;">{{ t.admin_link }}</a>
            </div>
        </div>

        {% if error %}
            <div class="error">{{ error }}</div>
        {% endif %}

        {% if success_message %}
            <div class="success">{{ success_message }}</div>
        {% endif %}

        <form id="uploadForm" action="/evaluate" method="post" enctype="multipart/form-data">
            <div class="form-group">
                <label>{{ t.participant_name }}</label>
                <input type="text" id="nameInput" name="name" required placeholder="{{ t.participant_name_placeholder }}">
            </div>
            
            <div class="form-group">
                <label>{{ t.upload_file }}</label>
                <input type="file" id="fileInput" name="file" accept=".json" required>
            </div>
            
            <button type="submit" id="submitBtn">{{ t.start_evaluation }}</button>
        </form>

        <!-- é€²åº¦æ¢å€åŸŸ -->
        <div id="progressContainer" style="display: none;">
            <div class="progress-wrapper">
                <h3 id="progressTitle">{{ t.processing_file }}</h3>
                <div class="progress-bar-container">
                    <div class="progress-bar" id="progressBar">
                        <span class="progress-text" id="progressText">0%</span>
                    </div>
                </div>
                <div class="progress-info">
                    <span id="progressDetail">{{ t.preparing }}</span>
                </div>
            </div>
        </div>

        <div id="leaderboard-section" style="margin-top: 50px; border-top: 2px solid #e2e8f0; padding-top: 40px;">
            <h2 style="color: #667eea; font-size: 2em; margin-bottom: 25px;">{{ t.leaderboard_title }}</h2>

            {% if leaders %}
            <table>
                <thead>
                    <tr>
                        <th>{{ t.rank }}</th>
                        <th>{{ t.name }}</th>
                        <th>{{ t.teds_score }}</th>
                        <th>{{ t.details }}</th>
                    </tr>
                </thead>
                <tbody>
                    {% for user in leaders %}
                    <tr {% if highlight_name and user.name == highlight_name %}class="highlight-row"{% endif %}>
                        <td>
                            {% if loop.index == 1 %}
                                <span class="badge badge-gold">ğŸ¥‡ 1</span>
                            {% elif loop.index == 2 %}
                                <span class="badge badge-silver">ğŸ¥ˆ 2</span>
                            {% elif loop.index == 3 %}
                                <span class="badge badge-bronze">ğŸ¥‰ 3</span>
                            {% else %}
                                {{ loop.index }}
                            {% endif %}
                        </td>
                        <td><strong>{{ user.name }}</strong></td>
                        <td><span class="metric-value">{{ "%.4f"|format(user.teds) }}</span></td>
                        <td>
                            <a href="/details/{{ user.name }}" class="detail-btn" title="{{ t.view_details }}">
                                {{ t.view_details }}
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
                <p class="info-text">{{ t.no_records }}</p>
            {% endif %}
        </div>
    </div>

    <script>
        const translations = {
            uploading: {{ t.uploading | tojson }},
            evaluating: {{ t.evaluating | tojson }},
            evaluationComplete: {{ t.evaluation_complete | tojson }},
            nameExists: {{ t.name_exists | tojson }},
            fillAllFields: {{ t.fill_all_fields | tojson }},
            connectionError: {{ t.connection_error | tojson }},
            startEvaluation: {{ t.start_evaluation | tojson }}
        };

        // WebSocket é€²åº¦æ¢é‚è¼¯
        document.getElementById('uploadForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const nameInput = document.getElementById('nameInput');
            const fileInput = document.getElementById('fileInput');
            const submitBtn = document.getElementById('submitBtn');
            const progressContainer = document.getElementById('progressContainer');
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');
            const progressDetail = document.getElementById('progressDetail');
            const progressTitle = document.getElementById('progressTitle');
            
            const name = nameInput.value.trim();
            const file = fileInput.files[0];
            
            if (!name || !file) {
                alert(translations.fillAllFields);
                return;
            }
            
            // æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨
            const existingNames = [{% for user in leaders %}'{{ user.name }}',{% endfor %}];
            if (existingNames.includes(name)) {
                alert(translations.nameExists.replace('{name}', name));
                return;
            }
            
            // ä¸Šå‚³æª”æ¡ˆåˆ°ä¼ºæœå™¨
            const formData = new FormData();
            formData.append('file', file);
            formData.append('name', name);
            
            try {
                // å…ˆä¸Šå‚³æª”æ¡ˆ
                submitBtn.disabled = true;
                submitBtn.textContent = translations.uploading;
                
                const uploadResponse = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                });
                
                const uploadResult = await uploadResponse.json();
                
                if (!uploadResult.success) {
                    throw new Error(uploadResult.error || '{{ t.file_upload_failed }}');
                }
                
                // é¡¯ç¤ºé€²åº¦æ¢
                progressContainer.style.display = 'block';
                submitBtn.textContent = translations.evaluating;
                
                // å»ºç«‹ WebSocket é€£æ¥
                const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                const sessionId = Date.now();
                const ws = new WebSocket(`${protocol}//${window.location.host}/ws/${sessionId}`);
                
                ws.onopen = function() {
                    // ç™¼é€è©•ä¼°è«‹æ±‚
                    ws.send(JSON.stringify({
                        name: name,
                        file_path: `data/uploads/${name}.json`
                    }));
                };
                
                ws.onmessage = function(event) {
                    const data = JSON.parse(event.data);
                    
                    if (data.type === 'progress') {
                        // æ›´æ–°é€²åº¦æ¢
                        progressBar.style.width = data.percentage + '%';
                        progressText.textContent = data.percentage + '%';
                        {% if lang == 'en' %}
                        progressDetail.textContent = `Evaluating ${data.current} / ${data.total} items (Table: ${data.current_key})`;
                        {% else %}
                        progressDetail.textContent = `æ­£åœ¨è©•ä¼°ç¬¬ ${data.current} / ${data.total} ç­†è³‡æ–™ (Table: ${data.current_key})`;
                        {% endif %}
                    } else if (data.type === 'complete') {
                        // è©•ä¼°å®Œæˆ
                        progressBar.style.width = '100%';
                        progressText.textContent = '100%';
                        progressTitle.textContent = translations.evaluationComplete;
                        {% if lang == 'en' %}
                        progressDetail.textContent = `TEDS score for ${name} is ${data.result.TEDS}`;
                        {% else %}
                        progressDetail.textContent = `${name} çš„ TEDS åˆ†æ•¸ç‚º ${data.result.TEDS}`;
                        {% endif %}
                        
                        // 1.5ç§’å¾Œé‡æ–°è¼‰å…¥é é¢ä»¥é¡¯ç¤ºæ›´æ–°å¾Œçš„æ’è¡Œæ¦œ
                        setTimeout(function() {
                            window.location.href = `/?success=${encodeURIComponent(name)}&score=${data.result.TEDS}`;
                        }, 1500);
                    } else if (data.type === 'error') {
                        // éŒ¯èª¤è™•ç†
                        progressContainer.style.display = 'none';
                        alert(data.message);
                        submitBtn.disabled = false;
                        submitBtn.textContent = translations.startEvaluation;
                    }
                };
                
                ws.onerror = function(error) {
                    console.error('WebSocket error:', error);
                    progressContainer.style.display = 'none';
                    alert(translations.connectionError);
                    submitBtn.disabled = false;
                    submitBtn.textContent = translations.startEvaluation;
                };
                
                ws.onclose = function() {
                    console.log('WebSocket connection closed');
                };
                
            } catch (error) {
                console.error('Error:', error);
                alert('{{ t.error_occurred }}'.replace('{error}', error.message));
                submitBtn.disabled = false;
                submitBtn.textContent = translations.startEvaluation;
                progressContainer.style.display = 'none';
            }
        });

        // è™•ç†æˆåŠŸåƒæ•¸
        const urlParams = new URLSearchParams(window.location.search);
        const successName = urlParams.get('success');
        const successScore = urlParams.get('score');
        
        if (successName && successScore) {
            // é¡¯ç¤ºæˆåŠŸè¨Šæ¯
            const container = document.querySelector('.container');
            const successDiv = document.createElement('div');
            successDiv.className = 'success';
            {% if lang == 'en' %}
            successDiv.textContent = `âœ… Evaluation complete! TEDS score for ${successName} is ${successScore}`;
            {% else %}
            successDiv.textContent = `âœ… è©•ä¼°å®Œæˆï¼${successName} çš„ TEDS åˆ†æ•¸ç‚º ${successScore}`;
            {% endif %}
            container.insertBefore(successDiv, container.firstChild.nextSibling);
            
            // æ»¾å‹•åˆ°æ’è¡Œæ¦œ
            setTimeout(function() {
                const leaderboard = document.getElementById('leaderboard-section');
                if (leaderboard) {
                    leaderboard.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            }, 300);
        }

        {% if highlight_name %}
        // ç•¶æœ‰æ–°ä¸Šå‚³çš„è¨˜éŒ„æ™‚ï¼Œå¹³æ»‘æ»¾å‹•åˆ°æ’è¡Œæ¦œå€åŸŸ
        document.addEventListener('DOMContentLoaded', function() {
            const leaderboard = document.getElementById('leaderboard-section');
            if (leaderboard) {
                setTimeout(function() {
                    leaderboard.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }, 300);
            }
        });
        {% endif %}
    </script>
</body>
</html>
